vhost-user-gpu: fix memory leak in vg_resource_attach_backing (CVE-2021-3544)


Check whether the 'res' has already been attach_backing to avoid
memory leak.

Fixes: CVE-2021-3544
Reported-by: default avatarLi Qiang <liq3ea@163.com>
virtio-gpu fix: 204f01b3

 ("virtio-gpu: fix memory leak
 in resource attach backing")
 Signed-off-by: default avatarLi Qiang <liq3ea@163.com>
 Reviewed-by: Marc-André Lureau's avatarMarc-André Lureau <marcandre.lureau@redhat.com>
 Message-Id: <20210516030403.107723-4-liq3ea@163.com>
 Signed-off-by: Gerd Hoffmann's avatarGerd Hoffmann <kraxel@redhat.com>

Upstream-Status: Backport
[vhost-user-gpu does not exist in 4.2.0 context]
CVE: CVE-2021-3544
Signed-off-by: Armin Kuster <akuster@mvista.com>


Index: qemu-4.2.0/contrib/vhost-user-gpu/main.c
===================================================================
--- qemu-4.2.0.orig/contrib/vhost-user-gpu/main.c
+++ qemu-4.2.0/contrib/vhost-user-gpu/main.c
@@ -468,6 +468,11 @@ vg_resource_attach_backing(VuGpu *g,
         return;
     }
 
+    if (res->iov) {
+        cmd->error = VIRTIO_GPU_RESP_ERR_UNSPEC;
+        return;
+    }
+
     ret = vg_create_mapping_iov(g, &ab, cmd, &res->iov);
     if (ret != 0) {
         cmd->error = VIRTIO_GPU_RESP_ERR_UNSPEC;
